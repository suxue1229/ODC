var BMapLib=window.BMapLib=BMapLib||{};(function(){function t(n){this._markerClusterer=n;this._map=n.getMap();this._minClusterSize=n.getMinClusterSize();this._isAverageCenter=n.isAverageCenter();this._center=null;this._markers=[];this._gridBounds=null;this._isReal=!1;this._clusterMarker=new BMapLib.TextIconOverlay(this._center,this._markers.length,{styles:this._markerClusterer.getStyles()})}var r=function(n,t,i){var r,u,f,o;return t=e(t),r=n.pointToPixel(t.getNorthEast()),u=n.pointToPixel(t.getSouthWest()),r.x+=i,r.y-=i,u.x-=i,u.y+=i,f=n.pixelToPoint(r),o=n.pixelToPoint(u),new BMap.Bounds(o,f)},e=function(n){var t=i(n.getNorthEast().lng,-180,180),r=i(n.getSouthWest().lng,-180,180),u=i(n.getNorthEast().lat,-74,74),f=i(n.getSouthWest().lat,-74,74);return new BMap.Bounds(new BMap.Point(r,f),new BMap.Point(t,u))},i=function(n,t,i){return t&&(n=Math.max(n,t)),i&&(n=Math.min(n,i)),n},u=function(n){return"[object Array]"===Object.prototype.toString.call(n)},f=function(n,t){var r=-1,i,f;if(u(t))if(t.indexOf)r=t.indexOf(n);else for(i=0;f=t[i];i++)if(f===n){r=i;break}return r},n=BMapLib.MarkerClusterer=function(n,t){var i,r,f;n&&(this._map=n,this._markers=[],this._clusters=[],i=t||{},this._gridSize=i.gridSize||60,this._maxZoom=i.maxZoom||18,this._minClusterSize=i.minClusterSize||2,this._isAverageCenter=!1,i.isAverageCenter!=undefined&&(this._isAverageCenter=i.isAverageCenter),this._styles=i.styles||[],r=this,this._map.addEventListener("zoomend",function(){r._redraw()}),this._map.addEventListener("moveend",function(){r._redraw()}),f=i.markers,u(f)&&this.addMarkers(f))};n.prototype.addMarkers=function(n){for(var t=0,i=n.length;t<i;t++)this._pushMarkerTo(n[t]);this._createClusters()};n.prototype._pushMarkerTo=function(n){var t=f(n,this._markers);t===-1&&(n.isInCluster=!1,this._markers.push(n))};n.prototype.addMarker=function(n){this._pushMarkerTo(n);this._createClusters()};n.prototype._createClusters=function(){for(var i=this._map.getBounds(),u=r(this._map,i,this._gridSize),t=0,n;n=this._markers[t];t++)!n.isInCluster&&u.containsPoint(n.getPosition())&&this._addToClosestCluster(n)};n.prototype._addToClosestCluster=function(n){for(var u,f,i,e=4e6,r=null,s=n.getPosition(),o=0;i=this._clusters[o];o++)u=i.getCenter(),u&&(f=this._map.getDistance(u,n.getPosition()),f<e&&(e=f,r=i));r&&r.isMarkerInClusterBounds(n)?r.addMarker(n):(i=new t(this),i.addMarker(n),this._clusters.push(i))};n.prototype._clearLastClusters=function(){for(var n=0,t;t=this._clusters[n];n++)t.remove();this._clusters=[];this._removeMarkersFromCluster()};n.prototype._removeMarkersFromCluster=function(){for(var n=0,t;t=this._markers[n];n++)t.isInCluster=!1};n.prototype._removeMarkersFromMap=function(){for(var t=0,n;n=this._markers[t];t++)n.isInCluster=!1,this._map.removeOverlay(n)};n.prototype._removeMarker=function(n){var t=f(n,this._markers);return t===-1?!1:(this._map.removeOverlay(n),this._markers.splice(t,1),!0)};n.prototype.removeMarker=function(n){var t=this._removeMarker(n);return t&&(this._clearLastClusters(),this._createClusters()),t};n.prototype.removeMarkers=function(n){for(var r,t=!1,i=0;i<n.length;i++)r=this._removeMarker(n[i]),t=t||r;return t&&(this._clearLastClusters(),this._createClusters()),t};n.prototype.clearMarkers=function(){this._clearLastClusters();this._removeMarkersFromMap();this._markers=[]};n.prototype._redraw=function(){this._clearLastClusters();this._createClusters()};n.prototype.getGridSize=function(){return this._gridSize};n.prototype.setGridSize=function(n){this._gridSize=n;this._redraw()};n.prototype.getMaxZoom=function(){return this._maxZoom};n.prototype.setMaxZoom=function(n){this._maxZoom=n;this._redraw()};n.prototype.getStyles=function(){return this._styles};n.prototype.setStyles=function(n){this._styles=n;this._redraw()};n.prototype.getMinClusterSize=function(){return this._minClusterSize};n.prototype.setMinClusterSize=function(n){this._minClusterSize=n;this._redraw()};n.prototype.isAverageCenter=function(){return this._isAverageCenter};n.prototype.getMap=function(){return this._map};n.prototype.getMarkers=function(){return this._markers};n.prototype.getClustersCount=function(){for(var n=0,t=0,i;i=this._clusters[t];t++)i.isReal()&&n++;return n};t.prototype.addMarker=function(n){var r,t;if(this.isMarkerInCluster(n))return!1;if(this._center){if(this._isAverageCenter){var i=this._markers.length+1,u=(this._center.lat*(i-1)+n.getPosition().lat)/i,f=(this._center.lng*(i-1)+n.getPosition().lng)/i;this._center=new BMap.Point(f,u);this.updateGridBounds()}}else this._center=n.getPosition(),this.updateGridBounds();if(n.isInCluster=!0,this._markers.push(n),r=this._markers.length,r<this._minClusterSize)return this._map.addOverlay(n),!0;if(r===this._minClusterSize)for(t=0;t<r;t++)this._markers[t].getMap()&&this._map.removeOverlay(this._markers[t]);return this._map.addOverlay(this._clusterMarker),this._isReal=!0,this.updateClusterMarker(),!0};t.prototype.isMarkerInCluster=function(n){if(this._markers.indexOf)return this._markers.indexOf(n)!=-1;for(var t=0,i;i=this._markers[t];t++)if(i===n)return!0;return!1};t.prototype.isMarkerInClusterBounds=function(n){return this._gridBounds.containsPoint(n.getPosition())};t.prototype.isReal=function(){return this._isReal};t.prototype.updateGridBounds=function(){var n=new BMap.Bounds(this._center,this._center);this._gridBounds=r(this._map,n,this._markerClusterer.getGridSize())};t.prototype.updateClusterMarker=function(){var n,t,i,r;if(this._map.getZoom()>this._markerClusterer.getMaxZoom()){for(this._clusterMarker&&this._map.removeOverlay(this._clusterMarker),n=0;t=this._markers[n];n++)this._map.addOverlay(t);return}if(this._markers.length<this._minClusterSize){this._clusterMarker.hide();return}this._clusterMarker.setPosition(this._center);this._clusterMarker.setText(this._markers.length);i=this._map;r=this.getBounds();this._clusterMarker.addEventListener("click",function(){i.setViewport(r)})};t.prototype.remove=function(){for(var n=0,t;t=this._markers[n];n++)this._markers[n].getMap()&&this._map.removeOverlay(this._markers[n]);this._map.removeOverlay(this._clusterMarker);this._markers.length=0;delete this._markers};t.prototype.getBounds=function(){for(var n=new BMap.Bounds(this._center,this._center),t=0,i;i=this._markers[t];t++)n.extend(i.getPosition());return n};t.prototype.getCenter=function(){return this._center}})();