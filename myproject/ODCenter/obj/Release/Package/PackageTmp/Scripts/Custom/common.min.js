var Navbar={set:function(){document.getElementById("nav_bar_top")!=null&&$.ajax({url:domain+"Nav",type:"post",dataType:"json",success:function(n){clearInterval(inthdl);var t="",i="";$.each(n,function(n,r){controller!=null&&r.controller==controller&&group!=null&&group.length==0?(t+="<li class='active head-main'><a href='"+domain+r.controller.toLowerCase()+"'>"+r.name+"<\/a><\/li>",i+="<a href='"+domain+r.controller.toLowerCase()+"' class='list-group-item active side-main'><span class='glyphicon "+r.icon+"'><\/span>"+r.name+"<\/a>"):(t+="<li class='head-main'><a href='"+domain+r.controller.toLowerCase()+"'>"+r.name+"<\/a><\/li>",i+="<a href='"+domain+r.controller.toLowerCase()+"' class='list-group-item side-main'><span class='glyphicon "+r.icon+"'><\/span>"+r.name+"<\/a>");$.each(r.subs,function(n,u){group!=null&&u.id==group&&controller!=null&&r.controller==controller?(t+="<li class='active head-sub'><a href='"+domain+r.controller.toLowerCase()+"/group/"+u.id+"'>"+u.name+"<\/a><\/li>",i+="<a href='"+domain+r.controller.toLowerCase()+"/group/"+u.id+"' class='list-group-item active side-sub'>"+u.name+"<\/a>"):(t+="<li class='head-sub'><a href='"+domain+r.controller.toLowerCase()+"/group/"+u.id+"'>"+u.name+"<\/a><\/li>",i+="<a href='"+domain+r.controller.toLowerCase()+"/group/"+u.id+"' class='list-group-item side-sub'>"+u.name+"<\/a>")})});$("#nav_bar_top").html(t);$("#nav_bar_side").html(i)}})}},Color={Good:"lightgreen",Slow:"lightgray",Poor:"darkgray",Dead:"dimgray",Warn:"orange",Erro:"red"};$("#router_query").click(function(){var n=$("#router_id").val(),t=Number(n);n.length==0||n.length>4||isNaN(t)?(alert("请输入正确的DTU ID尾号"),isNaN(t)&&$("#router_id").val(""),$("#router_id").focus()):Router.linkQuery(t)});$("#mode_lite").click(function(){$.cookie("mode","");window.location.reload()});$("#mode_full").click(function(){$.cookie("mode","full");window.location.reload()});$(document).on("click",".account-invite-create",function(){$.ajax({url:domain+"api/user/invite/",type:"put",dataType:"json",success:function(n){n.status==0&&(alert("已创建注册授权：\n  授权编码: "+n.data.Id+"\n  生成时间: "+n.data.Issued+"\n  过期时间: "+n.data.Expired),window.location.reload())}})});$(document).on("click",".account-invite-delete",function(){$.ajax({url:domain+"api/user/invite/"+$(this).data("invite-id"),type:"delete",dataType:"json",success:function(n){n.status==0&&window.location.reload()}})});$(document).on("click",".router-link-disconnect",function(){$.ajax({url:domain+"router/close/"+$(this).data("link-id"),type:"post",dataType:"json",success:function(){window.location.href=domain+"router"}})});var Common={pad:function(n,t){for(var i=n.toString().length;i<t;)n="0"+n,i++;return n},inArray:function(n,t){if(n==null)return!1;for(i=0;i<n.length&&n[i]!=t;i++);return!(i==n.length)},selectAll:function(n){var t=document.getElementsByTagName("*");$.each(t,function(t,i){i.type!="checkbox"||Common.inArray(n,i.id)||(i.checked=!0)})},selectNone:function(n){var t=document.getElementsByTagName("*");$.each(t,function(t,i){i.type!="checkbox"||Common.inArray(n,i.id)||(i.checked=!1)})},columns:function(){var n=document.body.clientWidth;return n>1360?5:n>1120?4:n>880?3:n>640?2:n>480?1:n>240?2:1},units:function(n){var t=Common.columns();return n!=null&&n.length>0?t==1?20:t==2?16:t==3?21:t==4?24:t==5?25:25:t==1?5:t==2?8:t==3?9:t==4?8:t==5?10:10},formula:function(n){return n},initUI:function(n){$("#nav_bar_top,.table-side").css("display",n=="Station"?"none":"")},clearInterval:function(){for(var n=0;n<99999;n++)clearInterval(n)},createElement:function(n,t,i,r,u){var f=document.createElement(n);return t!=null&&(f.className=t),i!=null&&(f.id=i),r!=null&&(f.innerHTML=r),u!=null&&(f.onclick=u),f}},DateTime={toString:function(n){return""+Common.pad(n.getFullYear(),4)+Common.pad(n.getMonth()+1,2)+Common.pad(n.getDate(),2)+Common.pad(n.getHours(),2)+Common.pad(n.getMinutes(),2)},fromString:function(n){return new Date(parseInt(n.substr(0,4)),parseInt(n.substr(4,2))-1,parseInt(n.substr(6,2)),parseInt(n.substr(8,2)),parseInt(n.substr(10,2)))},totalSeconds:function(n){return Math.floor(new Date(n).getTime()/1e3)}},Home={login:function(){var n=document.forms.home_login;$("#errortip").html("<div style='color:green;'>正在进行登录验证，请稍后...<\/div>");$.ajax({url:domain+"Account/Assert",type:"post",dataType:"json",data:"__RequestVerificationToken="+n.elements.__RequestVerificationToken.value+"&Email="+n.elements.Email.value+"&Password="+n.elements.Password.value,success:function(n){n.State!=null&&n.State=="Success"?($("#errortip").html(""),document.forms[0].submit()):$("#errortip").html("<div style='color:red;'>"+n.Errors+"<\/div>")}})}},Account={toggle:function(n){$.ajax({url:domain+"Account/Switch/",type:"post",dataType:"json",data:"institute="+n,success:function(n){n.message!=null?alert(n.message):window.location.href=domain+"Monitor"}})}},Map={insarr:[],init:function(){map=new BMap.Map("map-content");map.setMapType(BMAP_NORMAL_MAP);map.centerAndZoom(new BMap.Point(105,35),5);map.enableScrollWheelZoom();map.enableContinuousZoom();map.addControl(new BMap.ScaleControl);map.addControl(new BMap.MapTypeControl);map.addControl(new InsButtom);map.addControl(new InsList);Map.loadList()},loadList:function(){$.ajax({url:domain+"Map/List/",type:"post",dataType:"json",success:function(n){Map.insarr=[];n.status==0&&$.each(n.results,function(n,t){t.longitude!=null&&t.latitude!=null&&(t.convert=!1,Map.insarr.push(t))});Map.locConv()}})},locConv:function(){for(var t=[],n=0;n<Map.insarr.length&&t.length<10;n++)Map.insarr[n].convert||t.push(new BMap.Point(Map.insarr[n].longitude,Map.insarr[n].latitude));t.length==0?Map.render():(new BMap.Convertor).translate(t,1,5,function(n){n.status==0?($.each(n.points,function(n,t){for(var i=0;i<Map.insarr.length;i++)if(!Map.insarr[i].convert){Map.insarr[i].longitude=t.lng;Map.insarr[i].latitude=t.lat;Map.insarr[i].convert=!0;break}}),Map.locConv()):(console.log("[ERROR][LOCONV]"+JSON.stringify(n)),Map.render())})},render:function(){var n=[];$("#ins-body").html("");$.each(Map.insarr,function(t,i){(function(t){var r="factory-off.png",u,i;t.type==10&&(r="station-off.png");u=new BMap.Icon(domain+"images/map/"+r,new BMap.Size(48,48),{imageSize:new BMap.Size(48,48)});i=new BMap.Marker(new BMap.Point(t.longitude,t.latitude),{icon:u});i.setTitle(t.name);i.addEventListener("click",function(n){var r=n.target,f=new BMap.Point(r.getPosition().lng,r.getPosition().lat),i="<h4 style='margin:0 0 5px 0;padding:0.2em 0'>"+t.name+"<\/h4>",u;i+="<p>"+t.address+"<\/p>";i+="<div class='btn btn-default btn-sm' id='btn-map-marker' style='position:absolute;right:0;bottom:0;' onclick='Map.toggle()' data-id='"+t.id+"'>";i+="<span class='fa fa-play' style='color:green;'><\/span><\/div>";u=new BMap.InfoWindow(i,{width:250,height:80});map.openInfoWindow(u,f)});$("#ins-body").append(Common.createElement("div","ins-item",null,t.name+"<br><div class='description'>"+t.address+"<\/div>",function(){map.centerAndZoom(new BMap.Point(t.longitude,t.latitude),19);i.setLabel(new BMap.Label(t.name,{offset:new BMap.Size(38,0)}));map.width<=2*$("#ins-list").width()&&($("#ins-list").hide(),map.enableScrollWheelZoom());try{for(key in i)if($(i[key]).hasClass("BMap_noprint")){$(i[key]).trigger("click");break}}catch(n){}}));n.push(i)})(i)});map.clearOverlays();new BMapLib.MarkerClusterer(map,{markers:n})},toggle:function(){Account.toggle($("#btn-map-marker").data("id"))}},Sensor={showEdit:function(n){$.ajax({url:domain+"Sensor/Detail/"+n,type:"post",dataType:"json",success:function(t){var i="<div id='sen_value_edit' class='modal fade' role='dialog' aria-labelledby='modallabel' aria-hidden='true'>";i+="<div class='modal-dialog'>";i+="<div class='modal-content'>";i+="<div class='modal-header'>";i+="<button type='button' class='close' data-dismiss='modal' aria-hidden='true'>&times;<\/button>";i+="<h4 class='modal-title' id='modallabel'>设置"+t.name+"的数值<\/h4>";i+="<\/div>";i+="<div class='modal-body'><div class='form-horizontal'>";i+="<input type='hidden' id='sen_set_id' value='"+n+"'>";i+="<div class='form-group'><div class='col-sm-4 control-label'>新数值：<\/div><input type='number' class='col-sm-8 form-control' id='sen_set_value' value='"+t.value+"'><\/div>";i+="<\/div><\/div>";i+="<div class='modal-footer'>";i+="<a id='sen_edit_save' class='btn btn-primary'>设置<\/a>";i+="<a class='btn btn-default' data-dismiss='modal'>关闭<\/a>";i+="<\/div><\/div><\/div><\/div>";$("#sen_edit_panel").html(i);$("#sen_edit_save").click(function(){var n=$("#sen_set_value").val();n!=null&&n.length>0&&$.ajax({url:domain+"Sensor/Set/"+$("#sen_set_id").val(),type:"post",dataType:"json",data:"value="+n,success:function(n){n.result!="ok"&&alert(n.msg);$("#sen_value_edit").modal("hide")}})});$("#sen_value_edit").modal("show")}})},updateList:function(){var n=$("#DatType").val();$("#SenType option").each(function(){$(this).val()!="Undefined"&&(n=="BOOL"?$(this).attr("hidden",$(this).val().substring(0,7)!="Status_"):$(this).attr("hidden",$(this).val().substring(0,7)=="Status_"));$("#SenType").val()==$(this).val()&&$(this).attr("hidden")&&$("#SenType").val("Undefined")});$("#Inverse").parent().parent().attr("hidden",$("#SenType").val().substring(0,7)!="Status_");$("#Precise").parent().parent().attr("hidden",n=="BOOL")}},Client={},Router={loadList:function(){var n="<table class='table'><tr><th>连接ID<\/th><th>创建时间<\/th><th>最后活跃<\/th><th>PLC ID<\/th><th>DTU ID<\/th><th>客户端<\/th><th><\/th><\/tr>";$.ajax({url:domain+"router/link",type:"post",dataType:"json",success:function(t){$.each(t,function(t,i){n+="<tr><td><a href='"+domain+"router/conn/"+i.id+"'>"+i.id.substring(0,8)+"...<\/a><\/td><td>"+i.time+"<\/td><td>"+i.active+"<\/td><td>"+i.remote.plc+"<\/td><td>";n+=i.remote.dtu+"<\/td><td>"+(i.remote.name!=null?i.remote.name:"")+"<\/td><td>";n+="<a class='btn btn-manage router-link-disconnect' href='javascript:void(0);' data-link-id='"+i.id+"' title='断开连接'><span class='fa fa-chain-broken'><\/span><\/a><\/td><\/tr>"});n+="<\/table>";$("#link_panel").html(n)},error:function(){n+="<\/table>";$("#link_panel").html(n)}})},loadLink:function(){$.ajax({url:domain+"router/link/"+linkid,type:"post",dataType:"json",success:function(n){if(n.status==null||n.status!="ok"){Router.linkDead();return}var t=Router.linkTable("网络连接",{text:"断开连接",clazz:"router-link-disconnect",link_id:n.id},[{name:"ID",text:n.id},{name:"远程端IP",text:n.ip},{name:"创建时间",text:n.time},{name:"最后活跃",text:n.active},{name:"客户端ID",text:n.remote.client},{name:"客户端名称",text:n.remote.name}]);t+=Router.linkTable("流量统计",null,[{name:"发送包",text:n.txpack},{name:"发送字节",text:n.txbyte},{name:"接收包",text:n.rxpack},{name:"接收字节",text:n.rxbyte},{name:"无效字节",text:n.rxdrop}]);$("#link_panel").html(t);t=Router.linkTable("远程端",{text:"查看数据",link:detailurl+"/"+linkid},[{name:"PLC ID",text:n.remote.plc,group:"status",type:"number",index:0,id:"plcid_set",link:"javascript:void(0);",tip:"设置远程端PLC ID"},{name:"DTU ID",text:n.remote.dtu},{name:"启动时间",text:n.remote.boot},{name:"系统时间",text:n.remote.time,group:"status",type:"datetime",index:4,id:"time_set",link:"javascript:void(0);",tip:"设置远程端系统时间"},{name:"系统版本",text:n.remote.version}]);t+=Router.linkTable("流量统计",{text:"复位计数",group:"func",data:"20=0",id:"flow_reset"},[{name:"发送包",text:n.remote.txpack},{name:"发送失败",text:n.remote.txfail},{name:"发送字节",text:n.remote.txbyte},{name:"接收包",text:n.remote.rxpack},{name:"接收失败",text:n.remote.rxfail},{name:"接收字节",text:n.remote.rxbyte}]);t+=Router.linkTable("GPS信息",{text:"立即同步",group:"func",data:"7=0",id:"gps_sync"},[{name:"经度",text:n.remote.gpslon},{name:"纬度",text:n.remote.gpslat},{name:"时间",text:n.remote.gpstime}]);t+=Router.linkTable("同步间隔(s)",{text:"恢复默认",group:"stat",data:"32=0&33=0&34=0",id:"span_reset"},[{name:"数据同步",text:n.remote.datspan,group:"status",type:"number",index:32,id:"datspan_set",link:"javascript:void(0);",tip:"设置数据同步间隔"},{name:"状态同步",text:n.remote.staspan,group:"status",type:"number",index:33,id:"staspan_set",link:"javascript:void(0);",tip:"设置状态同步间隔"},{name:"GPS同步",text:n.remote.gpsspan,group:"status",type:"number",index:34,id:"gpsspan_set",link:"javascript:void(0);",tip:"设置GPS同步间隔"}]);$("#remote_panel").html(t);$("#plcid_set, #time_set, #datspan_set, #staspan_set, #gpsspan_set").click(function(){var n="<div id='edit_dialog' class='modal fade' role='dialog' aria-labelledby='modallabel' aria-hidden='true'>";n+="<div class='modal-dialog'>";n+="<div class='modal-content'>";n+="<div class='modal-header'>";n+="<button type='button' class='close' data-dismiss='modal' aria-hidden='true'>&times;<\/button>";n+="<h4 class='modal-title' id='modallabel'>"+$(this).attr("title").slice(2)+"<\/h4>";n+="<\/div>";n+="<div id='edit_body' class='modal-body'><form class='form-horizontal'>";n+="<div class='form-group'><label class='col-md-3 control-label'>原"+$(this).attr("name")+"<\/label><div class='col-md-9'>";n+="<input class='form-control text-box single-line' type='text' readonly='readonly' value='"+$(this).text()+"' /><\/div><\/div>";n+="<div class='form-group'><label class='col-md-3 control-label'>新"+$(this).attr("name")+"<\/label><div class='col-md-9'>";n+="<input class='form-control text-box single-line' id='set_value' xindex='"+$(this).attr("xindex")+"' type='"+$(this).attr("xtype")+"' value='' /><\/div><\/div>";n+="<\/form><\/div>";n+="<div class='modal-footer'>";$(this).attr("xtype")=="datetime"&&(n+="<a id='btn_now' class='btn btn-default'>快速校时<\/a>");n+="<a id='btn_set' class='btn btn-primary'>设置<\/a>";n+="<a class='btn btn-default' data-dismiss='modal' style='float:left;'>关闭<\/a>";n+="<\/div><\/div><\/div><\/div>";$("#pop_panel").html(n);$("#btn_now").click(function(){$.ajax({url:domain+"router/stat/"+linkid,type:"post",dataType:"json",data:$("#set_value").attr("xindex")+"=0",success:function(n){n.status=="ok"?alert("操作成功，请稍等以完成更新"):alert("连接已关闭或出现未知错误，请稍后重试")}});$("#edit_dialog").modal("hide")});$("#btn_set").click(function(){var n=$("#set_value").val();if(n==null||n.length==0){alert("无效设置，请检查并重新输入");return}$("#set_value").attr("type")=="datetime"&&(n=DateTime.totalSeconds(n));$.ajax({url:domain+"router/stat/"+linkid,type:"post",dataType:"json",data:$("#set_value").attr("xindex")+"="+n,success:function(n){n.status=="ok"?alert("操作成功，请稍等以完成更新"):alert("连接已关闭或出现未知错误，请稍后重试")}});$("#edit_dialog").modal("hide")});$("#edit_dialog").modal("show")});$("#flow_reset, #gps_sync, #span_reset").click(function(){$.ajax({url:domain+"router/"+$(this).attr("xgroup")+"/"+linkid,type:"post",dataType:"json",data:$(this).attr("xdata"),success:function(n){n.status=="ok"?alert("操作成功，请稍等以完成更新"):alert("连接已关闭或出现未知错误，请稍后重试")}})})}})},linkTable:function(n,t,i){var r="<div class='col-sm-6'><div style='padding-bottom:40px'><div style='float:left;font-size:large;font-weight:bold'>"+n+"<\/div>",u;return t!=null&&(r+="<div style='float:left;padding-left:50px'><a class='btn btn-default",t.clazz!=null&&(r+=" "+t.clazz),r+="'",t.id!=null&&(r+=" id='"+t.id+"'"),t.group!=null&&(r+=" xgroup='"+t.group+"'"),t.data!=null&&(r+=" xdata='"+t.data+"'"),t.link!=null&&(r+=" href='"+t.link+"'"),t.link_id!=null&&(r+=" data-link-id='"+t.link_id+"'"),r+=">"+t.text+"<\/a><\/div>"),r+="<\/div><table class='table'>",u=!0,$.each(i,function(n,t){r+="<tr><td";u&&(r+=" class='col-xs-5'",u=!1);r+=">"+t.name+"<\/td><td>";t.text!=null&&(t.link!=null?(r+="<a",t.id!=null&&(r+=" id='"+t.id+"'"),t.tip!=null&&(r+=" title='点击"+t.tip+"'"),t.group!=null&&(r+=" xgroup='"+t.group+"'"),t.type!=null&&(r+=" xtype='"+t.type+"'"),t.index!=null&&(r+=" xindex='"+t.index+"'"),r+=" name='"+t.name+"' href='"+t.link+"'>"+t.text+"<\/a>"):r+=t.text);r+="<\/td><\/tr>"}),r+="<\/table><\/div>"},loadData:function(){$.ajax({url:domain+"router/link/"+linkid,type:"post",dataType:"json",success:function(n){var i,t;if(n.status==null||n.status!="ok"){Router.linkDead();return}i=Router.dataTable("数据项",null,n.data);$("#data_panel").html(i);t=[];$.each(n.queue.data,function(n,i){t.push({id:i.id,type:"数据",name:i.name,value:i.value})});$.each(n.queue.stat,function(n,i){t.push({id:i.id,type:"状态",name:i.name,value:i.value})});$.each(n.queue.func,function(n,i){t.push({id:i.id,type:"功能",name:i.name,value:i.value})});i=Router.dataTable("发送队列",null,t);$("#queue_panel").html(i)}})},dataTable:function(n,t,i){var r="<div class='col-md-12'><div style='padding-bottom:40px'><div style='float:left;font-size:large;font-weight:bold'>"+n+"<\/div>";return t!=null&&(r+="<div style='float:right;'><a class='btn btn-default'",t.id!=null&&(r+=" id='"+t.id+"'"),t.link!=null&&(r+=" href='"+t.link+"'"),r+=">"+t.text+"<\/a><\/div>"),r+="<\/div><table class='table'>",r+="<tr><th class='col-xs-3'>ID<\/th><th class='col-xs-3'>类型<\/th><th class='col-xs-3'>名称<\/th><th>数值<\/th><\/tr>",$.each(i,function(n,t){r+="<tr><td>"+t.id+"<\/td><td>"+t.type+"<\/td><td>"+t.name+"<\/td><td>"+t.value+"<\/td><\/tr>"}),r+="<\/table><\/div>"},linkDead:function(){clearInterval(reload);var n="<div id='redirect_dialog' class='modal fade' role='dialog' aria-labelledby='modallabel' aria-hidden='true'>";n+="<div class='modal-dialog'>";n+="<div class='modal-content'>";n+="<div class='modal-header'>";n+="<button type='button' class='close' data-dismiss='modal' aria-hidden='true'>&times;<\/button>";n+="<h4 class='modal-title' id='modallabel'>连接已关闭<\/h4>";n+="<\/div>";n+="<div id='redirect_message' class='modal-body'><\/div>";n+="<\/div><\/div><\/div>";$("#pop_panel").html(n);Router.downCount(3,!0)},downCount:function(n,t){setTimeout(function(){t&&$("#redirect_dialog").modal("show");n>0?($("#redirect_message").html("页面将在"+n+"秒后跳转至列表..."),Router.downCount(n-1,!1)):location.href=domain+"router"},1e3)},setData:function(){},setStat:function(){},setFunc:function(){},linkQuery:function(n){$.post(domain+"open/router/query",{query:n},function(n){var t="<table class='table' style='max-width:520px;margin-left:auto;margin-right:auto;'>";t+="<tr><th>DTU ID<\/th><th>连接时间<\/th><th>最后活跃<\/th><\/tr>";n.status==0&&$.each(n.result,function(n,i){t+="<tr><td><a href='"+domain+"open/router/detail/"+i.id+"'>"+i.remote.dtu+"<\/a>";t+="<\/td><td>"+i.time+"<\/td><td>"+i.active+"<\/td><\/tr>"});t+="<\/table>";$("#router_result").html(t)})},linkInfo:function(){$.post(domain+"open/router/query",{id:conn_id},function(n){var t="";n.status==0?(t="<div class='col-md-6 col-xs-12'><div style='font-size:150%;'>连接信息<\/div><table class='table'>",t+="<tr><td>连接ID<\/td><td>"+n.result.id+"<\/td><\/tr>",t+="<tr><td>远程端IP<\/td><td>"+n.result.ip+"<\/td><\/tr>",t+="<tr><td>创建时间<\/td><td>"+n.result.time+"<\/td><\/tr>",t+="<tr><td>最后活跃<\/td><td>"+n.result.active+"<\/td><\/tr>",t+="<tr><td>客户端ID<\/td><td>"+n.result.remote.client+"<\/td><\/tr>",t+="<tr><td>客户端名称<\/td><td>"+n.result.remote.name+"<\/td><\/tr>",t+="<tr><td>PLC ID<\/td><td>"+n.result.remote.plc+"<\/td><\/tr>",t+="<tr><td>DTU IP<\/td><td>"+n.result.remote.dtu+"<\/td><\/tr>",t+="<tr><td>启动时间<\/td><td>"+n.result.remote.boot+"<\/td><\/tr>",t+="<tr><td>系统时间<\/td><td>"+n.result.remote.time+"<\/td><\/tr>",t+="<tr><td>系统版本<\/td><td>"+n.result.remote.version+"<\/td><\/tr>",t+="<tr><td>GPS位置<\/td><td>"+n.result.remote.gpslon+", "+n.result.remote.gpslat+"<\/td><\/tr>",t+="<tr><td>GPS时间<\/td><td>"+n.result.remote.gpstime+"<\/td><\/tr>",t+="<\/table><\/div>",t+="<div class='col-md-6 col-xs-12'><div style='font-size:150%;'>远程端信息<\/div><table class='table'><tr><th>编号<\/th><th>名称<\/th><th>类型<\/th><th>数值<\/th><\/tr>",$.each(n.result.data,function(n,i){t+="<tr><td>"+i.id+"<\/td><td>"+i.name+"<\/td><td>"+i.type+"<\/td><td>"+i.value+"<\/td><\/tr>"}),t+="<\/table><\/div>"):t="<div style='text-align:center;'><h4>连接不存在或发生错误<\/h4><\/div>";$("#router_link").html(t)})}},Monitor={updateImage:function(){$.ajax({url:domain+"Sensor/Group/",type:"post",dataType:"json",data:"limit=1000",success:function(n){var t=new Date(n.time);n.groups!=null&&$.each(n.groups,function(n,i){i.devices!=null&&i.devices.length>0&&$.each(i.devices,function(n,t){if(document.getElementById(t.id+"_img")){var r=document.getElementById(t.id+"_img"),i=t.status.match(/{(.*)}(.*)/);r.innerHTML=i==null?"<label>"+t.status+"<\/label>":"<label style=color:"+i[1]+";'>"+i[2]+"<\/label>"}});i.sensors!=null&&i.sensors.length>0&&$.each(i.sensors,function(n,i){if(document.getElementById(i.id+"_img")){var r=document.getElementById(i.id+"_img"),u=t-new Date(i.time);r.innerHTML=u>3e4?"<label>#####<\/label>":"<label>"+i.value.substring(0,6)+"<\/label>"}})})}})},loadList:function(){$.ajax({url:domain+"Sensor/Group/"+group,type:"post",dataType:"json",data:"limit="+Common.units(group)+"&offset="+offset,success:function(n){var t="",i=new Date(n.time);Common.initUI(n.type);n.type=="Station"?($.each(n.groups,function(n,i){t+="<div class='frame_header col-xs-12'>";t+="<label style='font-size:120%;font-weight:normal;padding-top:5px;'>"+i.name+"<\/label>";$.each(i.devices,function(n,i){t+="<div class='col-xs-12'>";t+="<label><a href='"+domain+"manage/detail/"+i.id+"'>"+i.name+"<\/a><\/label>";var r=i.status.match(/{(.*)}(.*)/);t+=r==null?"<label style='float:right;'>"+i.status+"<\/label>":"<label style='float:right;color:"+r[1]+";'>"+r[2]+"<\/label>";$.each(i.sensors,function(n,i){t+="<div class='col-xs-12' style='padding-right:0;color:dimgray;'>";t+="<label><a href='"+domain+"monitor/detail/"+i.id+"'>"+i.name+"<\/a><\/label>";t+="<label style='float:right;'>"+i.value;i.unit&&(t+=" "+i.unit);t+="<\/label><\/div>"});t+="<\/div>"});$.each(i.sensors,function(n,i){t+="<div class='col-xs-12'>";t+="<label><a href='"+domain+"monitor/detail/"+i.id+"'>"+i.name+"<\/a><\/label>";t+="<label style='float:right;'>"+i.value;i.unit&&(t+=" "+i.unit);t+="<\/label><\/div>"});t+="<\/div>"}),$("#list_panel").html(t)):n.groups!=null&&($.each(n.groups,function(n,r){var f,u;if(offset=r.offset,r.sensors!=null&&r.sensors.length>0&&(t+="<div class='frame_header col-xs-12'><label style='font-size:120%;font-weight:normal;padding-top:5px;'>"+r.name+"<\/label>",(group==null||group.length==0)&&r.count>r.sensors.length&&(t+="<a class='btn' style='float:right' href='#' onclick=\"javascript:window.location.href='"+domain+"monitor/group/"+r.id+"';\">更多<\/a>"),t+="<\/div><div class='col-xs-12'>",$.each(r.sensors,function(n,r){t+="<div class='sensor_frame'>";var u=i-new Date(r.time);r.edit!=null&&r.edit==!0&&(u=0,t+="<button type='button' class='btn btn-default' style='position:absolute;top:8px;right:8px;width:20px;height:20px;' onclick='Sensor.showEdit(\""+r.id,t+="\")'><span class='glyphicon glyphicon-pencil' style='position:absolute;top:2px;left:6px;'><\/span><\/button>");u>3e4&&(t+="<span class='glyphicon glyphicon-link' style='position:absolute;top:10px;right:10px;'><\/span>");t+="<button type='button' class='sensor_btn'";t+=u>3e4?" style='background-color:"+Color.Dead+";' onclick='Monitor.showDetail(this.id)' id='"+r.id+"'>"+r.name+"<br />#####":u>2e4?" style='background-color:"+Color.Poor+";' onclick='Monitor.showDetail(this.id)' id='"+r.id+"'>"+r.name+"<br />"+r.value:u>1e4?" style='background-color:"+Color.Slow+";' onclick='Monitor.showDetail(this.id)' id='"+r.id+"'>"+r.name+"<br />"+r.value:" style='background-color:"+Color.Good+";' onclick='Monitor.showDetail(this.id)' id='"+r.id+"'>"+r.name+"<br />"+r.value;r.unit!=null&&r.unit.length>0&&(t+="("+r.unit+")");t+="<\/button><\/div>"}),t+="<\/div>",group!=null&&group.length>0&&r.count>r.sensors.length)){for(t+="<div class='col-xs-12'><nav style='text-align:center;'><ul class='pagination' style='margin:0;'>",f=Math.floor(r.offset/r.limit)+1,u=1;u<=Math.ceil(r.count/r.limit);u++)t+="<li",u==f&&(t+=" class='active'"),t+=" style='padding:0;line-height:1;'><a href='#' onclick=\"javascript:offset=Common.units('"+r.id+"')*"+(u-1)+';Monitor.loadList();">'+u+"<\/a><\/li>";t+="<\/ul><\/nav><\/div>"}}),$("#list_panel").html(t))}})},showDetail:function(n){window.location.href=domain+"Monitor/Detail/".toLowerCase()+n},loadDetail:function(){$.ajax({url:domain+"Sensor/Detail/"+id,type:"post",dataType:"json",success:function(n){Common.initUI(n.ins.type);var t="",i=new Date(n.srvtime)-new Date(n.time);t+="<div class='col-sm-4 detail_value'>仪表名称: "+n.name+"<\/div>";t+="<div class='col-sm-4 detail_value'>所属机构: "+n.ins.name+"<\/div>";t+="<div class='col-sm-4 detail_value'>实时数值: ";n.edit!=null&&n.edit==!0&&(i=0);t+=i>3e4?"#####":n.value;n.unit!=null&&n.unit.length>0&&(t+="("+n.unit+")");n.edit!=null&&n.edit==!0&&(t+="<button type='button' class='btn btn-link' style='padding:0px;text-indent:3px;height:18px;width:24px;' onclick='Sensor.showEdit(\""+n.id,t+="\")'><span class='glyphicon glyphicon-md  glyphicon-pencil'><\/span><\/button>");t+="<\/div>";$("#detail_panel").html(t)}})},loadChart:function(n){n!=null&&(zoomlevel=zoomlevel+n,chart_dat=null);chart_dat==null&&(document.getElementById("loading_state").style.color="orange",$("#loading_state").html("正在加载历史数据..."),setTimeout(Monitor.resetLoading,1500),$.ajax({url:domain+"Sensor/Track/"+id+"?level="+zoomlevel+"&time="+DateTime.toString(new Date),type:"post",dataType:"json",success:function(n){var e,f,l,u;document.getElementById("loading_state").style.color="green";$("#loading_state").html("加载完成!");setTimeout(Monitor.resetLoading,500);n.level!=null&&n.level!=zoomlevel&&(zoomlevel=n.level);e=["即时视图","小时视图","日视图","周视图","月视图","年视图"];document.getElementById("chart_zoomout").disabled=zoomlevel>=5;$("#chart_zoomout").attr("title",e[Math.min(5,Math.max(0,zoomlevel+1))]);document.getElementById("chart_zoomin").disabled=zoomlevel<=0;$("#chart_zoomin").attr("title",e[Math.min(5,Math.max(0,zoomlevel-1))]);$("#chart_refresh").attr("title","刷新"+e[Math.min(5,Math.max(0,zoomlevel))]);chart_dat={labels:[],datasets:[{label:"History Data",fillColor:"rgba(100,100,100,0.2)",strokeColor:"rgba(50,50,50,1)",pointColor:"rgba(50,50,50,1)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(0,0,0,1)",data:[]}]};var o=0,i=0,r=0,s=0,h,c;if(n.his!=null&&(f="",$.each(n.his,function(n,t){var u=new Date(t.time);r==0?(h=c=u,o=i=s=t.value):(h=Math.min(h,u),c=Math.max(c,u),o=Math.min(o,t.value),s=Math.max(s,t.value),i=i+t.value);r=r+1;zoomlevel==1||zoomlevel==2?(f=Common.pad(u.getFullYear(),4)+"年"+Common.pad(u.getMonth()+1,2)+"月"+Common.pad(u.getDate(),2)+"日",chart_dat.labels.push(Common.pad(u.getHours(),2)+"h")):zoomlevel==3?(f=Common.pad(u.getFullYear(),4)+"年",chart_dat.labels.push(Common.pad(u.getMonth()+1,2)+"-"+Common.pad(u.getDate(),2))):zoomlevel==4?chart_dat.labels.push(Common.pad(u.getFullYear(),4)+"-"+Common.pad(u.getMonth()+1,2)):zoomlevel==5?chart_dat.labels.push(Common.pad(u.getFullYear(),4)):(f=Common.pad(u.getFullYear(),4)+"年"+Common.pad(u.getMonth()+1,2)+"月"+Common.pad(u.getDate(),2)+"日",chart_dat.labels.push(Common.pad(u.getHours(),2)+":"+Common.pad(u.getMinutes(),2)));chart_dat.datasets[0].data.push(t.value)}),$("#chart_tip").html(f),Monitor.drawChart(),r>0)){if(l="",r==1)l+="一次";else{var t=(c-h)/1e3,a=0,v=0,y=0,p=0;p=Math.floor(t*10)/10;t=t/60;y=Math.floor(t*10)/10;t=t/60;v=Math.floor(t*10)/10;t=t/24;a=Math.floor(t*10)/10;l+=a>=1?a+"天":v>=1?v+"小时":y>=1?y+"分钟":p+"秒"}i=i/r;u="";u+="<div class='col-xs-12 detail_value'>最近"+l+"的统计数据：<\/div>";u+="<div class='col-sm-12 detail_value' style='text-indent:20px;'>最小值:"+o.toPrecision(2)+"<\/div><\/div>";u+="<div class='col-sm-12 detail_value' style='text-indent:20px;'>平均值:"+i.toPrecision(2)+"<\/div><\/div>";u+="<div class='col-sm-12 detail_value' style='text-indent:20px;'>最大值:"+s.toPrecision(2)+"<\/div><\/div>";$("#summary_panel").html(u)}}}))},resetLoading:function(){$("#loading_state").html("")},drawChart:function(){var n=document.body.clientWidth,t,i;n>=1200?n=1170:n>=992?n=970:n>=768&&(n=750);n>480&&(n=n-160);n=n-20;$("#chart_panel").attr("width",n);$("#chart_panel").attr("height",.48*n);t=$("#chart_panel").get(0);i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);chart_dat!=null&&chart_dat.datasets[0].data.length>0&&(chart=chart_dat.datasets[0].data.length>1?new Chart(i,{type:"line",data:chart_dat}):new Chart(i,{type:"bar",data:chart_dat}))}},Manage={loadList:function(){$.ajax({url:domain+"Device/Group/"+group,type:"post",dataType:"json",data:"limit="+Common.units(group)+"&offset="+offset,success:function(n){var t="",i=new Date(n.time);n.groups!=null&&($.each(n.groups,function(n,i){var u,r;if(offset=i.offset,i.devices!=null&&i.devices.length>0&&(t+="<div class='frame_header col-xs-12'><label style='font-size:120%;font-weight:normal;padding-top:5px;'>"+i.name+"<\/label>",(group==null||group.length==0)&&i.count>i.devices.length&&(t+="<a class='btn' style='float:right' href='#' onclick=\"javascript:window.location.href='"+domain+"manage/group/"+i.id+"';\">更多<\/a>"),t+="<\/div>",$.each(i.devices,function(n,i){t+="<div class='sensor_frame'>";t+="<button type='button' class='sensor_btn' style='background-color:";i.status==null&&(i.status="{orange}Unknown");var r=i.status.match(/{(.*)}(.*)/);t+=r==null?"orange":r[1]=="green"?"lightgreen":r[1];t+=";' onclick='Manage.showDetail(this.id)' id='"+i.id+"'>"+i.name+"<br />";t+=r==null?i.status:r[2];t+="<\/button>";t+="<\/div>"}),group!=null&&group.length>0&&i.count>i.devices.length)){for(t+="<div class='col-md-12'><nav style='text-align:center;'><ul class='pagination' style='margin:0;'>",u=Math.floor(i.offset/i.limit)+1,r=1;r<=math.ceil(i.count/i.limit);r++)t+="<li",r==u&&(t+=" class='active'"),t+=" style='padding:0;line-height:1;'><a href='#' onclick=\"javascript:offset=Common.units('"+i.id+"')*"+(r-1)+';Manage.loadList();">'+r+"<\/a><\/li>";t+="<\/ul><\/nav><\/div>"}}),$("#list_panel").html(t))}})},showDetail:function(n){window.location.href=domain+"Manage/Detail/".toLowerCase()+n},loadDetail:function(){$.ajax({url:domain+"Device/Detail/"+id,type:"post",dataType:"json",success:function(n){var i,f,r,t,u;Common.initUI(n.ins.type);i="";f=new Date(n.srvtime);i+="<div class='col-sm-4 detail_value'>设备名称: "+n.name+"<\/div>";i+="<div class='col-sm-4 detail_value'>所属机构: "+n.ins.name+"<\/div>";i+="<div class='col-sm-4 detail_value'>设备状态: ";n.status==null&&(n.status="{orange}Unknown");r=n.status.match(/{(.*)}(.*)/);i+=r==null?n.status:"<span style='color:"+r[1]+";'>"+r[2]+"<\/span>";n.edit&&(i+="<button class='btn btn-link' style='padding:0px;text-indent:3px;height:18px;width:24px;' id='"+n.id+"' data-toggle='tooltip' title='修改状态' onclick='Manage.editState(this.id)'><span class='glyphicon glyphicon-md glyphicon-pencil'><\/span><\/button>");i+="<\/div>";$("#detail_panel").html(i);t="";u=0;n.sensors!=null&&($.each(n.sensors,function(n,i){u=u+1;t+=u%2==0?"<div class='col-xs-12' style='border-radius:3px;padding-left:0;padding-right:0;background-color:lightgray;'>":"<div class='col-xs-12' style='border-radius:3px;padding-left:0;padding-right:0;background-color:whitesmoke;'>";t+="<div class='col-xs-4'>"+i.name+"<\/div>";t+="<div class='col-xs-4'";var r=f-new Date(i.time);t+=r>3e4?" style='color:red;'>#####":r>2e4?" style='color:orangered;'>"+i.value:r>1e4?" style='color:orange;'>"+i.value:" style='color:green;'>"+i.value;i.unit!=null&&i.unit.length>0&&(t+="("+i.unit+")");t+="<\/div><div class='col-xs-4 text-center'><button class='btn btn-link' style='padding:0px;width:28px;' data-toggle='tooltip' title='仪表详情' onclick='Monitor.showDetail(this.id)' id='"+i.id+"'><span class='glyphicon glyphicon-md glyphicon-info-sign'><\/span><\/button><\/div><\/div>"}),$("#sensor_panel").html(t))}})},editState:function(n){$.ajax({url:domain+"Device/State/"+n,type:"get",dataType:"html",cache:!1,success:function(n){$("#summary_holder").html(n);var t=document.forms.state_edit.elements.Status.value.match(/{(.*)}(.*)/);if(t!=null){switch(t[1]){case"green":Manage.toggleState("stat_ok");break;case"red":Manage.toggleState("stat_err");break;default:Manage.toggleState("stat_ukw")}document.forms.state_edit.elements.Status.value=t[2]}$("#editstate").modal("show")}})},toggleState:function(n){["stat_ok","stat_ukw","stat_err"].forEach(function(t){document.getElementById(t).className=n==t?"btn btn-default active":"btn btn-default"})},setState:function(n){switch(n.style.color){case"green":Manage.toggleState("stat_ok");break;case"red":Manage.toggleState("stat_err");break;default:Manage.toggleState("stat_ukw")}document.forms.state_edit.elements.Status.value=n.innerHTML},saveState:function(){var n=document.forms.state_edit,t=document.getElementById("stat_ok").className=="btn btn-default active"?"green":document.getElementById("stat_err").className=="btn btn-default active"?"red":"orange";t="{"+t+"}";$.ajax({url:domain+"Device/State/"+id,type:"post",dataType:"json",data:"__RequestVerificationToken="+n.elements.__RequestVerificationToken.value+"&Id="+n.elements.Id.value+"&Name="+n.elements.Name.value+"&Status="+t+n.elements.Status.value,success:function(n){n.result=="ok"?$("#editstate").modal("hide"):$("#errortip").html(n.msg);Manage.loadDetail()}})},newTrack:function(){$.ajax({url:domain+"Device/Track/Create/"+id,type:"get",dataType:"html",cache:!1,success:function(n){$("#summary_holder").html(n);$("#createtrack").modal("show")}})},createTrack:function(){var n=document.forms.track_create;$.ajax({url:domain+"Device/Track/Create/",type:"post",dataType:"json",data:"__RequestVerificationToken="+n.elements.__RequestVerificationToken.value+"&HisTime="+n.elements.HisTime.value+"&DeviceId="+n.elements.DeviceId.value+"&Description="+n.elements.Description.value,success:function(n){n.State=="Success"?$("#createtrack").modal("hide"):$("#errortip").html(n.Errors);Manage.loadTrack()}})},editTrack:function(n){$.ajax({url:domain+"Device/Track/Edit/"+n,type:"get",dataType:"html",cache:!1,success:function(n){$("#summary_holder").html(n);$("#edittrack").modal("show")}})},saveTrack:function(){var n=document.forms.track_edit;$.ajax({url:domain+"Device/Track/Edit/",type:"post",dataType:"json",data:"__RequestVerificationToken="+n.elements.__RequestVerificationToken.value+"&Id="+n.elements.Id.value+"&HisTime="+n.elements.HisTime.value+"&DeviceId="+n.elements.DeviceId.value+"&Description="+n.elements.Description.value,success:function(n){n.State=="Success"?$("#edittrack").modal("hide"):$("#errortip").html(n.Errors);Manage.loadTrack()}})},deleteTrack:function(n){$.ajax({url:domain+"Device/Track/Delete/"+n,type:"get",dataType:"html",cache:!1,success:function(n){$("#summary_holder").html(n);$("#deletetrack").modal("show")}})},removeTrack:function(){var n=document.forms.track_delete;$.ajax({url:domain+"Device/Track/Delete/",type:"post",dataType:"json",data:"__RequestVerificationToken="+n.elements.__RequestVerificationToken.value+"&Id="+n.elements.Id.value,success:function(n){$("#deletetrack").modal("hide");n.State!="Success"&&alert(n.Errors);Manage.loadTrack()}})},loadTrack:function(){document.getElementById("loading_state").style.color="orange";$("#loading_state").html("正在加载设备记录...");setTimeout(Manage.resetLoading,1500);$.ajax({url:domain+"Device/Track/Fetch/"+id,type:"post",dataType:"json",success:function(n){document.getElementById("loading_state").style.color="green";$("#loading_state").html("加载完成!");var t="";t+="<div class='col-sm-4 col-md-3 col-lg-3 detail_value'>记录时间<\/div>";t+="<div class='col-sm-4 col-md-5 col-lg-6 detail_value'>操作描述<\/div>";t+="<div class='col-sm-4 col-md-4 col-lg-3 detail_value'>操作员<\/div>";$.each(n,function(n,i){t+="<div class='col-sm-4 col-md-3 col-lg-3 detail_value'>"+i.time+"<\/div>";t+="<div class='col-sm-4 col-md-5 col-lg-6 detail_value'>"+i.log+"<\/div>";t+="<div class='col-sm-4 col-md-4 col-lg-3 detail_value'>"+i.oper;t+="<button class='btn btn-link' style='padding:0px;text-indent:3px;height:18px;width:24px;' id='"+i.id+"' data-toggle='tooltip' title='修改纪录' onclick='Manage.editTrack(this.id)'><span class='glyphicon glyphicon-md glyphicon-pencil'><\/span><\/button>";t+="<button class='btn btn-link' style='padding:0px;text-indent:3px;height:18px;width:24px;' id='"+i.id+"' data-toggle='tooltip' title='删除纪录' onclick='Manage.deleteTrack(this.id)'><span class='glyphicon glyphicon-md glyphicon-trash'><\/span><\/button>";t+="<\/div>"});$("#summary_panel").html(t);setTimeout(Manage.resetLoading,500)}})},resetLoading:function(){$("#loading_state").html("")}},Report={pageEdit:function(){var n="";n+="<div id='data_page' class='modal fade' role='dialog' aria-labelledby='modallabel' aria-hidden='true'>";n+="<div class='modal-dialog'>";n+="<div class='modal-content'>";n+="<div class='modal-header'>";n+="<button type='button' class='close' data-dismiss='modal' aria-hidden='true'>&times;<\/button>";n+="<h4 class='modal-title' id='modallabel'>"+name+"的页面设置<\/h4>";n+="<\/div>";n+="<div class='modal-body'><form class='form-horizontal'>";$.each([["PageWidth","页面宽度"],["PageHeight","页面高度"],["MarginTop","上边距"],["MarginBottom","下边距"],["MarginLeft","左边距"],["MarginRight","右边距"]],function(t,i){n+="<div class='form-group'><label class='col-md-3 control-label'>"+i[1]+"<\/label><div class='col-md-9'>";n+="<input class='form-control text-box single-line' id='page_"+i[0]+"' type='text' value='' /><\/div><\/div>"});n+="<\/form><\/div>";n+="<div class='modal-footer'>";n+="<a id='btn_page_save' class='btn btn-primary'>保存<\/a>";n+="<a class='btn btn-default' data-dismiss='modal' style='float:left;'>关闭<\/a>";n+="<\/div><\/div><\/div><\/div>";$("#page_panel").html(n);$("#btn_page_save").click(function(){var n="";$.each(["PageWidth","PageHeight","MarginTop","MarginBottom","MarginLeft","MarginRight"],function(t,i){var r=document.getElementById("page_"+i),u;r!=null&&r.value!=null&&r.value.length>0&&(u=parseFloat(r.value),r.value.indexOf("cm")>0&&(u*=.3937),n+=i+"="+u.toFixed(2)+"in;")});$("#data_page").modal("hide");$("#PageInfo").val(n)});$.each($("#PageInfo").val().split(";"),function(n,t){if(t!=null&t.length>0){var i=t.split("=");$("#page_"+i[0]).val(i[1])}});$("#data_page").modal("show")},tempUpload:function(){var n="";n+="<div id='temp_upload' class='modal fade' role='dialog' aria-labelledby='modallabel' aria-hidden='true'>";n+="<div class='modal-dialog'>";n+="<div class='modal-content'>";n+="<div class='modal-header'>";n+="<button type='button' class='close' data-dismiss='modal' aria-hidden='true'>&times;<\/button>";n+="<h4 class='modal-title' id='modallabel'>报告模板上传<\/h4>";n+="<\/div>";n+="<div class='modal-body'><form id='file_upload_form' class='form-horizontal' action='"+domain+"Report/Upload/"+id+"' method='post' enctype='multipart/form-data'>";n+="<div class='form-group'><label class='col-md-3 control-label'>选择模板文件<\/label><div class='col-md-9'>";n+="<input class='form-control text-box single-line' id='file_to_upload' type='file' accept='.rdlc' value='' /><\/div><\/div>";n+="<\/form><\/div>";n+="<div class='modal-footer'>";n+="<a id='btn_file_upload' class='btn btn-primary'>上传<\/a>";n+="<a class='btn btn-default' data-dismiss='modal' style='float:left;'>关闭<\/a>";n+="<\/div><\/div><\/div><\/div>";n+="";$("#file_panel").html(n);$("#btn_file_upload").click(function(){var t=$("form#file_upload_form"),i=new FormData,n=$("#file_to_upload").get(0).files[0];if(n==null){alert("请选择报告模板文件。");return}if(n.type!="application/xml"||n.name.substring(n.name.lastIndexOf(".")+1).toLowerCase()!="rdlc"){alert("所选文件不是有效的报告模板文件，请重新选择。");return}i.append("upload",n,n.name);$.ajax({url:t.attr("action"),method:t.attr("method"),data:i,enctype:"multipart/form-data",success:function(n){n.result!=null&&n.result==!0?(alert("报告模板上传成功。"),$("#temp_upload").modal("hide")):n.msg!=null&&alert("报告模板上传失败:"+n.msg);n.file!=null&&$("#temp_file_status").val(n.file)},cache:!1,contentType:!1,processData:!1})});$("#temp_upload").modal("show")},tempEdit:function(){try{temp=$.parseJSON($("#DataSource").val())}catch(t){temp={};temp.Items=[]}var n="";n+="<div id='data_source' class='modal fade' role='dialog' aria-labelledby='modallabel' aria-hidden='true'>";n+="<div class='modal-dialog'>";n+="<div class='modal-content'>";n+="<div class='modal-header'>";n+="<button type='button' class='close' data-dismiss='modal' aria-hidden='true'>&times;<\/button>";n+="<h4 class='modal-title' id='modallabel'>"+name+" - 数据源<\/h4>";n+="<\/div>";n+="<div id='temp_cont_panel' class='modal-body'>";n+="<\/div>";n+="<div class='modal-footer'>";n+="<a id='btn_temp_add' class='btn btn-default'>新增<\/a>";n+="<a id='btn_temp_del' class='btn btn-default'>删除<\/a>";n+="<a id='btn_temp_edit' class='btn btn-default'>编辑<\/a>";n+="<a id='btn_temp_save' class='btn btn-primary'>保存<\/a>";n+="<a class='btn btn-default' data-dismiss='modal' style='float:left;'>关闭<\/a>";n+="<\/div><\/div><\/div><\/div>";n+="";$("#temp_panel").html(n);$("#btn_temp_add").click(function(){item={};item.Ids=[];Report.itemName()});$("#btn_temp_del").click(function(){$("input:checkbox").each(function(){var t,n,i;if($(this).attr("id").substring(0,4)=="itm_"&&$(this).is(":checked")==!0&&(t=$(this).attr("id").substring(4),confirm("确认删除数据源"+t+"？"))){for(n=[];temp.Items.length>0;)if(i=temp.Items.pop(),i.Name==t)break;else n.push(i);while(n.length>0)temp.Items.push(n.pop())}});Report.tempUpdate()});$("#btn_temp_edit").click(function(){$("input:checkbox").each(function(){if($(this).attr("id").substring(0,4)=="itm_"&&$(this).is(":checked")==!0){var n=$(this).attr("id").substring(4);return $.each(temp.Items,function(){if(this.Name==n){item={};for(var t in this)if(t=="Ids")for(item.Ids=[],i=0;i<this.Ids.length;i++)item.Ids.push(this.Ids[i]);else item[t]=this[t];item.Ori=this.Name}}),!1}});Report.itemName()});$("#btn_temp_save").click(function(){$("#DataSource").val(JSON.stringify(temp));$("#data_source").modal("hide")});$("#data_source").modal("show");Report.tempUpdate();ids==null&&Report.idsLoad()},tempUpdate:function(){var n="";n+="<table class='table'>";n+="<tr><th><\/th><th>Name<\/th><th>Count<\/th><th><\/th>";temp!=null&&temp.Items!=null&&$.each(temp.Items,function(t,i){n+="<tr><td><input type='checkbox' id='itm_"+i.Name+"' /><\/td>";n+="<td>"+i.Name+"<\/td>";n+="<td>"+i.Ids.length+"<\/td><\/tr>"});n+="<\/table>";$("#temp_cont_panel").html(n)},itemName:function(){$("#data_item").modal("hide");var n="";n+="<div id='data_item' class='modal fade' role='dialog' aria-labelledby='modallabel' aria-hidden='true'>";n+="<div class='modal-dialog'>";n+="<div class='modal-content'>";n+="<div class='modal-header'>";n+="<button type='button' class='close' data-dismiss='modal' aria-hidden='true'>&times;<\/button>";n+="<h4 class='modal-title' id='modallabel'>"+name+" - 新增数据源 - 名称<\/h4>";n+="<\/div>";n+="<div class='modal-body'><form class='form-horizontal'>";n+="<div class='form-group'><label class='col-md-3 control-label'>数据名称<\/label><div class='col-md-9'>";n+="<input class='form-control text-box single-line' id='item_ItemName' type='text' value='' /><\/div><\/div>";n+="<\/form><\/div>";n+="<div class='modal-footer'>";n+="<a id='btn_item1_fw' class='btn btn-primary'>下一步<\/a>";n+="<a class='btn btn-default' data-dismiss='modal' style='float:left;'>关闭<\/a>";n+="<\/div><\/div><\/div><\/div>";$("#item_panel").html(n);$("#btn_item1_fw").click(function(){if(item.Name=$("#item_ItemName").val().trim(),item.Name==null||item.Name.length==0){alert("数据源名称无效，请重新输入。");return}var n=!0;$.each(temp.Items,function(){if(item.Ori==null&&this.Name==item.Name||item.Ori!=null&&this.Name!=item.Ori&&this.Name==item.Name)return alert("数据源名称重复，请重新输入。"),n=!1,!1});n&&Report.itemSubs()});$("#item_ItemName").val(item.Name);$("#data_item").modal("show")},itemSubs:function(){var n,t;$("#data_item").modal("hide");n="";n+="<div id='data_item' class='modal fade' role='dialog' aria-labelledby='modallabel' aria-hidden='true'>";n+="<div class='modal-dialog'>";n+="<div class='modal-content'>";n+="<div class='modal-header'>";n+="<button type='button' class='close' data-dismiss='modal' aria-hidden='true'>&times;<\/button>";n+="<h4 class='modal-title' id='modallabel'>"+name+" - 新增数据源 - 项列表<\/h4>";n+="<\/div>";n+="<div id='item_subs_panel' class='modal-body'>";n+="<\/div>";n+="<div class='modal-footer'>";n+="<a id='btn_item2_bw' class='btn btn-default'>上一步<\/a>";n+="<a id='btn_item2_add' class='btn btn-default'>增加项<\/a>";n+="<a id='btn_item2_del' class='btn btn-default'>删除项<\/a>";n+="<a id='btn_item2_fw' class='btn btn-primary'>下一步<\/a>";n+="<a class='btn btn-default' data-dismiss='modal' style='float:left;'>关闭<\/a>";n+="<\/div><\/div><\/div><\/div>";$("#item_panel").html(n);t=function(){if(ids!=null){var n="";n+="<table class='table'>";n+="<tr><th><\/th><th>Group<\/th><th>Name<\/th>";$.each(ids,function(){n+="<tr><td><input type='checkbox' id='ids_"+this.Id+"' /><\/td>";n+="<td>"+this.Group+"<\/td>";n+="<td>"+this.Name+"<\/td><\/tr>"});n+="<\/table>";$("#subs_list_panel").html(n)}};$("#btn_item2_bw").click(function(){Report.itemName()});$("#btn_item2_add").click(function(){var n="";n+="<div id='item_subs' class='modal fade' role='dialog' aria-labelledby='modallabel' aria-hidden='true'>";n+="<div class='modal-dialog'>";n+="<div class='modal-content'>";n+="<div class='modal-header'>";n+="<button type='button' class='close' data-dismiss='modal' aria-hidden='true'>&times;<\/button>";n+="<h4 class='modal-title' id='modallabel'>添加项至列表<\/h4>";n+="<\/div>";n+="<div id='subs_list_panel' class='modal-body'>";n+="<\/div>";n+="<div class='modal-footer'>";n+="<a id='btn_add_ids' class='btn btn-primary'>添加<\/a>";n+="<a class='btn btn-default' data-dismiss='modal' style='float:left;'>关闭<\/a>";n+="<\/div><\/div><\/div><\/div>";$("#subs_panel").html(n);ids==null&&Report.idsLoad();t();$("#btn_add_ids").click(function(){$("input:checkbox").each(function(){if($(this).attr("id").substring(0,4)=="ids_"&&$(this).is(":checked")==!0){var n=$(this).attr("id").substring(4);item.Ids.push(n)}});Report.itemUpdate();$("#item_subs").modal("hide")});$("#item_subs").modal("show")});$("#btn_item2_del").click(function(){$("input:checkbox").each(function(){var i,n,t;if($(this).attr("id").substring(0,4)=="sub_"&&$(this).is(":checked")==!0){for(i=$(this).attr("id").substring(4),n=[];item.Ids.length>0;)t=item.Ids.pop(),t!=i&&n.push(t);while(n.length>0)item.Ids.push(n.pop())}});Report.itemUpdate()});$("#btn_item2_fw").click(function(){Report.itemCfg()});$("#data_item").modal("show");Report.itemUpdate()},idsLoad:function(){$.ajax({url:domain+"Sensor/Group/",type:"post",dataType:"json",data:"limit=1000&ins="+ins,success:function(n){ids=[];n.groups!=null&&$.each(n.groups,function(n,t){t.sensors!=null&&t.sensors.length>0&&$.each(t.sensors,function(n,i){var r={};r.Group=t.name;r.Id=i.id;r.Name=i.name;ids.push(r)})})}})},itemUpdate:function(){ids==null&&Report.idsLoad();var n="";n+="<table class='table'>";n+="<tr><th><\/th><th>Group<\/th><th>Name<\/th>";item!=null&&item.Ids!=null&&$.each(item.Ids,function(t,i){n+="<tr><td><input type='checkbox' id='sub_"+i+"' /><\/td>";var r=!1;$.each(ids,function(){if(this.Id==i)return n+="<td>"+this.Group+"<\/td>",n+="<td>"+this.Name+"<\/td><\/tr>",r=!0,!1});r||(n+="<td><\/td><td>"+i+"<\/td><\/tr>")});n+="<\/table>";$("#item_subs_panel").html(n)},itemCfg:function(){var t,n;$("#data_item").modal("hide");t="";t+="<option value='Hour'>一小时<\/option>";t+="<option value='Day'>一天<\/option>";t+="<option value='Week'>一周<\/option>";t+="<option value='Month'>一个月<\/option>";t+="<option value='Year'>一年<\/option>";n="";n+="<div id='data_item' class='modal fade' role='dialog' aria-labelledby='modallabel' aria-hidden='true'>";n+="<div class='modal-dialog'>";n+="<div class='modal-content'>";n+="<div class='modal-header'>";n+="<button type='button' class='close' data-dismiss='modal' aria-hidden='true'>&times;<\/button>";n+="<h4 class='modal-title' id='modallabel'>"+name+" - 新增数据源 - 配置<\/h4>";n+="<\/div>";n+="<div class='modal-body'><form class='form-horizontal'>";n+="<div class='form-group'><label class='col-md-3 control-label'>数据跨度<\/label><div class='col-md-9'>";n+="<select id='item_Span' class='form-control dropdown single-line'>"+t+"<\/select><\/div><\/div>";n+="<div class='form-group'><label class='col-md-3 control-label'>间隔精度<\/label><div class='col-md-9'>";n+="<select id='item_Level' class='form-control dropdown single-line'>"+t+"<\/select><\/div><\/div>";n+="<div class='form-group'><label class='col-md-3 control-label'>自然边界<\/label><div class='col-md-9'>";n+="<input class='form-control checkbox single-line' id='item_Slip' type='checkbox' value='' /><\/div><\/div>";n+="<div class='form-group'><label class='col-md-3 control-label'>数量限制<\/label><div class='col-md-9'>";n+="<input class='form-control text-box single-line' id='item_Limit' type='number' value='' /><\/div><\/div>";n+="<div class='form-group'><label class='col-md-3 control-label'>当前时间<\/label><div class='col-md-9'>";n+="<input class='form-control checkbox single-line' id='item_TimeCur' type='checkbox' checked='checked' /><\/div><\/div>";n+="<div class='form-group'><label class='col-md-3 control-label'>指定时间<\/label><div class='col-md-9'>";n+="<input class='form-control datetime single-line' id='item_TimeSet' type='datetime' value='' disabled='true' /><\/div><\/div>";n+="<\/form><\/div>";n+="<div class='modal-footer'>";n+="<a id='btn_item3_bw' class='btn btn-default'>上一步<\/a>";n+="<a id='btn_item3_fw' class='btn btn-primary'>保存<\/a>";n+="<a class='btn btn-default' data-dismiss='modal' style='float:left;'>关闭<\/a>";n+="<\/div><\/div><\/div><\/div>";$("#item_panel").html(n);$("#item_TimeCur").click(function(){$("#item_TimeCur").is(":checked")?$("#item_TimeSet").attr("disabled","disabled"):$("#item_TimeSet").removeAttr("disabled")});var i=function(n){return Common.pad(n.getFullYear(),4)+"-"+Common.pad(n.getMonth()+1,2)+"-"+Common.pad(n.getDate(),2)+" "+Common.pad(n.getHours(),2)+":"+Common.pad(n.getMinutes(),2)+":"+Common.pad(n.getSeconds(),2)},u=function(){if(item.Span!=null&&$("#item_Span").val(item.Span),item.Level!=null&&$("#item_Level").val(item.Level),(item.Slip==null||item.Slip==!0)&&$("#item_Slip").attr("checked",!0),$("#item_Limit").val(0),item.Limit!=null&&$("#item_Limit").val(item.Limit),$("#item_TimeCur").attr("checked",!0),$("#item_TimeSet").val(""),$("#item_TimeSet").attr("disabled","disabled"),item.Time!=null){var n=new Date(item.Time.replace(/-/g,"/"));n!="Invalid Date"&&($("#item_TimeCur").attr("checked",!1),$("#item_TimeSet").val(i(n)),$("#item_TimeSet").removeAttr("disabled"))}},r=function(){var n,t;item.Span=$("#item_Span").val();item.Level=$("#item_Level").val();item.Slip=$("#item_Slip").is(":checked");n=$("#item_Limit").val().trim();item.Limit=0;n.length>0&&(item.Limit=n*1);item.Time=null;$("#item_TimeCur").is(":checked")||(t=new Date($("#item_TimeSet").val().replace(/-/g,"/")),t!="Invalid Date"&&(item.Time=i(t)))};$("#btn_item3_bw").click(function(){r();Report.itemSubs()});$("#btn_item3_fw").click(function(){var n,t;for(r(),temp==null&&(temp={}),temp.Items==null&&(temp.Items=[]),n=[];temp.Items.length>0;)t=temp.Items.pop(),t.Name!=item.Ori&&t.Name!=item.Name&&n.push(t);while(n.length>0)temp.Items.push(n.pop());delete item.Ori;temp.Items.push(item);$("#data_item").modal("hide");Report.tempUpdate()});u();$("#data_item").modal("show")},editTime:function(n){var t="<div id='time_edit' class='modal fade' role='dialog' aria-labelledby='modallabel' aria-hidden='true'>",i,r;for(t+="<div class='modal-dialog'>",t+="<div class='modal-content'>",t+="<div class='modal-header'>",t+="<button type='button' class='close' data-dismiss='modal' aria-hidden='true'>&times;<\/button>",t+="<h4 class='modal-title' id='modallabel'>设置报告时间<\/h4>",t+="<\/div>",t+="<div class='modal-body'>",t+="<select id='rpt_year'><\/select>年",t+="<select id='rpt_month'><\/select>月",t+="<select id='rpt_day'><\/select>日&nbsp;",t+="<select id='rpt_hour'><\/select>时",t+="<select id='rpt_minute'><\/select>分",t+="<\/div>",t+="<div class='modal-footer'>",t+="<a id='time_edit_clear' class='btn btn-default' style='float:left;'>清除<\/a>",t+="<a id='time_edit_set' class='btn btn-primary'>设置<\/a>",t+="<a class='btn btn-default' data-dismiss='modal'>关闭<\/a>",t+="<\/div><\/div><\/div><\/div>",$("#time_panel").html(t),$("#time_edit_clear").click(function(){timeid!=null&&($(timeid).val(""),$(timeid).hasClass("btn-link")&&$(timeid).removeClass("btn-link"));$("#time_edit").modal("hide")}),$("#time_edit_set").click(function(){if(timeid!=null){var n=new Date($("#rpt_year").val(),$("#rpt_month").val()-1,$("#rpt_day").val(),$("#rpt_hour").val(),$("#rpt_minute").val());n!="Invalid Date"?($(timeid).val(n.toString()),$(timeid).hasClass("btn-link")||$(timeid).addClass("btn-link")):$(timeid).hasClass("btn-link")&&$(timeid).removeClass("btn-link")}$("#time_edit").modal("hide")}),t="",i=2014;i<=(new Date).getFullYear();i++)t+="<option>"+i+"<\/option>";for($("#rpt_year").html(t),t="",i=1;i<=12;i++)t+="<option>"+i+"<\/option>";for($("#rpt_month").html(t),t="",i=1;i<=31;i++)t+="<option>"+i+"<\/option>";for($("#rpt_day").html(t),t="",i=0;i<=23;i++)t+="<option>"+i+"<\/option>";for($("#rpt_hour").html(t),t="",i=0;i<=59;i++)t+="<option>"+i+"<\/option>";$("#rpt_minute").html(t);r=new Date($(n).val());r=="Invalid Date"&&(r=new Date);$("#rpt_year").val(r.getFullYear());$("#rpt_month").val(r.getMonth()+1);$("#rpt_day").val(r.getDate());$("#rpt_hour").val(r.getHours());$("#rpt_minute").val(r.getMinutes());timeid=n;$("#time_edit").modal("show")},genReport:function(n){var r=$(n).attr("id").substring(0,3),t=$(n).attr("id").substring(4),u=new Date($("#rpt_"+t).val()),i="";u!="Invalid Date"&&(i="?time="+DateTime.toString(u));r=="rpv"?window.open(domain+"pdf/viewer.html?file="+domain+"report/pdf/"+t+encodeURIComponent(i)):r=="rpp"?window.open(domain+"report/pdf/"+t+i):r=="rpe"&&window.open(domain+"report/excel/"+t+i)}},Vision={};